# Serverless Image Processing Project with AWS SNS, SQS, and Lambda üöÄ

## Project Overview üåê

This project leverages Amazon's serverless tools ‚Äì SNS, SQS, and Lambda ‚Äì to efficiently handle image processing tasks. By replacing traditional EC2 instances with Lambda functions, it demonstrates how modern, event-driven solutions can simplify work, cut costs, and use resources smartly. Dive in to see how SNS, SQS, and Lambda collaborate for a responsive and budget-friendly image processing setup.

## Architecture Overview üèóÔ∏è

In this architecture, the process begins with a user uploading an image to an Amazon S3 bucket. This action triggers an S3 event notification, which is then sent to an SNS topic. The SNS topic efficiently distributes notifications to three SQS queues. These queues, in turn, trigger Lambda functions responsible for resizing the image into various formats. The final resized images are saved back to the S3 bucket, completing the workflow.

![Overview](https://github.com/renilsequeira/serverless-sns-sqs-lambda/assets/77531126/d19feaba-87f9-4b29-a806-e95431bef513)

### Image Processing Workflow Overview üîÑ

#### User Uploads Image to S3 Bucket üì§

A user initiates the workflow by uploading an image file to an Amazon S3 bucket. This action triggers an event notification within the S3 bucket.

#### S3 Event Notification to SNS Topic üì©

Upon uploading the image file, an S3 event notification is automatically sent to an Amazon SNS (Simple Notification Service) topic. This topic acts as a central hub for handling notifications.

#### SNS Distributes Notifications to SQS Queues üì§

The SNS topic is configured to distribute notifications to three separate Amazon SQS (Simple Queue Service) queues. Each SQS queue is subscribed to the SNS topic, allowing it to receive relevant notifications.

#### Lambda Functions Triggered by SQS Queues üöÄ

Each SQS queue triggers a specific AWS Lambda function responsible for image processing. There are three Lambda functions, each designed to process images in a different format.

#### Lambda Functions Resize and Save to S3 Bucket üíæ

The Lambda functions receive notifications from the SQS queues and proceed to resize the uploaded images in their respective formats. The resulting resized images are then saved to a different folder within the same S3 bucket.

#### Validation of Processed Images ‚úÖ

After the Lambda functions have executed, you can validate the processed images in the designated folders within the S3 bucket. These folders should contain the resized copies of the originally uploaded images.

#### Logs in Amazon CloudWatch üìù

Additionally, logs generated by the Lambda functions during image processing are available in Amazon CloudWatch. You can review these logs for insights into the execution and any potential issues encountered during the image processing workflow.

With this setup, we can process images in various formats simultaneously, making everything super quick and responsive. It's like having a backstage pass to parallel image processing ‚Äì talk about a game-changer! üéâ

## Project Setup ‚öôÔ∏è

1. **Create an Amazon SNS Topic:**
   - Follow [Task 1](#step-1-create-a-standard-amazon-sns-topic) in the documentation.

2. **Create Amazon SQS Queues:**
   - Follow [Task 2](#step-2-create-three-amazon-sqs-queues) in the documentation.

3. **Configure Amazon S3 Event Notification:**
   - Follow [Task 3](#step-3-create-an-amazon-s3-event-notification) in the documentation.

4. **Create and Configure Lambda Functions:**
   - Follow [Task 4](#step-4-create-and-configure-three-aws-lambda-functions) in the documentation.

5. **Upload an Object to the Amazon S3 Bucket:**
   - Follow [Task 5](#step-5-upload-an-object-to-the-amazon-s3-bucket) in the documentation.

6. **Validate the Processed File:**
   - Follow [Task 6](#step-6-validate-the-processed-file) in the documentation.

## Step 1: Create a Standard Amazon SNS Topic üìå

### Setting up an Amazon SNS Topic üöÄ

1. **Navigate to Simple Notification Service (SNS):**
   - Open the AWS Console and search for and select "Simple Notification Service."

2. **Choose Topics:**
   - From the options on the left, select "Topics."

3. **Create a New Topic:**
   - Click on "Create topic."

4. **Configure Topic Details:**
   - In the "Create topic" page under "Details," configure as follows:
     - *Type:* Choose "Standard."
     - *Name:* Enter a unique SNS topic name, like "resize-image-topic" 
   - Click "Create topic."

5. **Verify Creation:**
   - Look for the confirmation message. It should be something like:
     ```
     Topic resize-image-topic-1234 created successfully.
     ```

6. **Copy ARN and Topic Owner Values:**
   - In the "Details" section, copy the ARN (Amazon Resource Name) for your topic.
   - Also, grab the AWS account ID of the topic owner.
   - Save these values in notepad for future use.

7. **Note:**
   - Make sure to accurately copy the following values for reference in subsequent tasks of the lab. These details will be the keys to connecting different parts of our project seamlessly.
     - *Topic Name:* [Your Chosen Topic Name]
     - *Topic ARN (Amazon Resource Name):* [Copied ARN]
     - *AWS Account ID (Topic Owner):* [Copied AWS Account ID]

   These values are essential for configuring other components in the workflow. Keep them handy for a smooth setup process.

## Step 2: Create Three Amazon SQS Queues üì¶

### Step 2.1: Create an Amazon SQS Queue for the Thumbnail üñºÔ∏è

**Objective:** Create an SQS queue named thumbnail-queue for processing thumbnail images.

1. **Navigate to Simple Queue Service (SQS):**

2. **Create a New Queue:**
   - On the SQS home page, choose "Create queue."

3. **Configure Queue Details:**
   - On the "Create queue" page, in the "Details" section:
     - *Type:* Choose "Standard" (default).
     - *Name:* Enter `thumbnail-queue`.
     - Leave the default values for other configuration parameters.
   - Choose "Create queue."

4. **Verify Queue Creation:**
   - Check for the expected service output message:
     ```
     Queue thumbnail-queue created successfully.
     ```

### Step 2.2: Subscribe Thumbnail Queue to SNS Topic üíå

**Objective:** Subscribe the thumbnail-queue to the SNS topic.

1. **Access the SQS Queue Detail Page:**
   - On the queue's detail page, choose the "SNS subscriptions" tab.

2. **Subscribe to Amazon SNS Topic:**
   - Choose "Subscribe to Amazon SNS topic."

3. **Specify SNS Topic:**
   - In the "Use existing resource" section, choose the `resize-image-topic` SNS topic created earlier.
   - Choose "Save."

4. **Verify Subscription:**
   - Check for the expected service output message:
     ```
     Subscribed successfully to topic arn:aws:sns:region:account-id:resize-image-topic-xxxx.
     ```
   - This confirms that the `thumbnail-queue` has been successfully subscribed to the `resize-image-topic` SNS topic.

### Step 2.3: Create and Subscribe Two More SQS Queues üöÄ

**Objective:** Create two additional SQS queues (`web-queue` and `mobile-queue`) and subscribe them to the `resize-image-topic`.

1. **Create SQS Queue for Web-Sized Images:**
   - Follow the same steps as in Step 2.1, but name the queue `web-queue`.

2. **Subscribe Web Queue to SNS Topic:**
   - Follow the steps in Step 2.2 to subscribe `web-queue` to the `resize-image-topic`.

3. **Create SQS Queue for Mobile-Sized Images:**
   - Follow the same steps as in Step 2.1, but name the queue `mobile-queue`.

4. **Subscribe Mobile Queue to SNS Topic:**
   - Follow the steps in Step 2.2 to subscribe `mobile-queue` to the `resize-image-topic`.

5. **Verify Queue and Subscription Creation:**
   - Check for the expected service output messages:
     ```
     Queue web-queue created successfully.
     Subscribed successfully to topic arn:aws:sns:region:account-id:resize-image-topic-xxxx.

     Queue mobile-queue created successfully.
     Subscribed successfully to topic arn:aws:sns:region:account-id:resize-image-topic-xxxx.
     ```
![3SQS_Queue](https://github.com/renilsequeira/serverless-sns-sqs-lambda/assets/77531126/405250a6-732a-4084-b313-e4ad3f334f1b)

**Step Complete:**
You have successfully created three Amazon SQS queues and subscribed them to the `resize-image-topic` SNS topic for receiving image resizing notifications.

## Step 3: Create an Amazon S3 Event Notification

### Step 3.1: Configure Amazon SNS Access Policy üìù

**Objective:** Configure the Amazon SNS access policy to allow the Amazon S3 bucket to publish to the topic.

1. **Access the AWS Management Console:**
   - Open the AWS Management Console.

2. **Navigate to Simple Notification Service (SNS):**
   - From the left navigation menu, choose "Topics."
   - Select Resize Image Topic:
     - Choose the `resize-image-topic` topic created earlier.

3. **Edit Topic Access Policy:**
   - Choose "Edit."

4. **Access Policy Configuration:**
   - In the Access policy section, expand it if necessary.

5. **Update Access Policy JSON:**
   - Delete the existing content from the JSON editor.
   - Copy and paste the provided code block into the JSON Editor section (replace placeholders).

   ## IAM Policy for SNS Topic Access

```json
{
  "Version": "2008-10-17",
  "Id": "__default_policy_ID",
  "Statement": [
    {
      "Sid": "__default_statement_ID",
      "Effect": "Allow",
      "Principal": {
        "AWS": "*"
      },
      "Action": [
        "SNS:GetTopicAttributes",
        "SNS:SetTopicAttributes",
        "SNS:AddPermission",
        "SNS:RemovePermission",
        "SNS:DeleteTopic",
        "SNS:Subscribe",
        "SNS:ListSubscriptionsByTopic",
        "SNS:Publish",
        "SNS:Receive"
      ],
      "Resource": "SNS_TOPIC_ARN",
      "Condition": {
        "StringEquals": {
          "AWS:SourceAccount": "SNS_TOPIC_OWNER"
        }
      }
    },
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "s3.amazonaws.com"
      },
      "Action": "SNS:Publish",
      "Resource": "SNS_TOPIC_ARN",
      "Condition": {
        "StringEquals": {
          "AWS:SourceAccount": "SNS_TOPIC_OWNER"
        }
      }
    }
  ]
}
```
Replace placeholders:
Replace region with your AWS region.
Replace account-id with your AWS account ID.
Replace your-ingest-bucket-name with the name of your ingest S3 bucket.
Save Changes:
Choose "Save."

Note:

Ensure that you replace placeholders such as region, account-id, and your-ingest-bucket-name with your specific AWS region, account ID, and S3 bucket name.
This configuration allows the specified S3 bucket to publish events to the resize-image-topic.

## Step 3.2: Create an S3 Event Notification for Uploads to the Ingest S3 Bucket üöÄ

1. **Navigate to Amazon S3:**
   - On the Buckets page, choose the bucket hyperlink with a name like `xxxxx-bucket-xxxxx`.

2. **Access Bucket Properties:**
   - Choose the "Properties" tab.

3. **Scroll to Event Notifications Section:**
   - Scroll down to the "Event notifications" section.

4. **Create Event Notification:**
   - Choose "Create event notification."

5. **Configure General Settings:**
   - In the General configuration section:
      - *Event name:* Enter `resize-image-event`.
      - *Prefix - optional:* Enter `ingest/`.
      - *Suffix - optional:* Enter `.jpg`.

6. **Configure Event Types:**
   - In the Event types section, select "All object create events."

7. **Configure Destination Settings:**
   - In the Destination section, configure the following:
      - *Destination:* Select "SNS topic."
      - *Specify SNS topic:* Select "Choose from your SNS topics."
      - *SNS topic:* Choose the `resize-image-topic` SNS topic from the dropdown menu.

8. **Alternative Option:**
   - If you prefer to specify an ARN, choose "Enter ARN" and enter the ARN you copied in Task 1.

9. **Save Changes:**
   - Choose "Save changes."

10. **Verify Notification Creation:**
    - Check for the expected service output message:
      ```
      Successfully created event notification ‚Äúresize-image-event‚Äù.
      ```

**Step Complete:**
You have successfully created an Amazon S3 event notification for object create events with specific filters, directing notifications to the `resize-image-topic` SNS topic.

## Step 4.1: Create a Lambda Function to Generate a Thumbnail

**Objective:** Create an AWS Lambda function with an SQS trigger to generate a thumbnail.

1. **Navigate to AWS Lambda:**
   - Open the AWS Lambda console.

2. **Create Lambda Function:**
   - Choose "Create function."

3. **Configure Basic Information:**
   - In the "Create function" window, select "Author from scratch."
   - In the Basic information section, configure the following:
      - *Function name:* Enter `CreateThumbnail`.
      - *Runtime:* Choose `Python 3.9`.

4. **Change Default Execution Role:**
   - Expand the "Change default execution role" section.
   - Select "Use an existing role."
   - Choose the role with a name like `xxxxx-LabExecutionRole-xxxxx`.
     - *Note:* This role provides necessary permissions for Lambda to access Amazon S3 and Amazon SQS.

5. **Create Lambda Function:**
   - Choose "Create function."

6. **Verify Creation:**
   - Check for the expected service output message:
     ```
     Successfully created the function CreateThumbnail. You can now change its code and configuration. To invoke your function with a test event, choose ‚ÄúTest‚Äù.
     ```

**Step Complete:**
You have successfully created an AWS Lambda function named CreateThumbnail with the necessary configuration.

## Step 4.2: Configure Lambda Function with SQS Trigger and Upload Deployment Package

**Objective:** Add an SQS trigger to the Lambda function and upload the Python deployment package.

1. **Access the AWS Lambda Console:**
   - Open the AWS Lambda console.

2. **Navigate to CreateThumbnail Lambda Function:**
   - Select the "CreateThumbnail" Lambda function that you created.

3. **Add SQS Trigger:**
   - Choose "Add trigger."
   - Configure the following:
      - *Select a trigger:* Choose "SQS."
      - *SQS Queue:* Choose "thumbnail-queue."
      - *Batch Size:* Enter 1.
   - Scroll to the bottom of the page and choose "Add."

4. **Verify Trigger Addition:**
   - Check for the expected service output message:
     ```
     The trigger thumbnail-queue was successfully added to function CreateThumbnail. The trigger is in a disabled state.
     ```

5. **Configure Lambda Function Code:**
   - Choose the "Code" tab.
   - Instead of manually entering code, you'll upload it as a deployment package.

6. **Upload Deployment Package:**
   - Follow these steps to upload the deployment package:
      - Save the provided file (CreateThumbnail.zip) to your computer.
      - Open the "Upload from" menu and choose ".zip file."
      - Choose the "Upload" button, navigate to and select the deployment package you saved.
      - Choose "Save."

7. **Verify Package Upload:**
   - Check for the expected service output message:
     ```
     Successfully updated the function CreateThumbnail.
     ```
   - *Note:* The provided CreateThumbnail.zip file contains the Lambda function code. Do not copy this code; it's just an example to show what's in the zip file.
     ```python
     # Import necessary libraries
      import boto3
      import os
      import sys
      import uuid
      from PIL import Image
      import PIL.Image
      import json
      import time

      # Initialize AWS clients
      s3_client = boto3.client('s3')
      s3 = boto3.resource('s3')
      
      # Function to resize an image
      def resize_image(image_path, resized_path):
          with Image.open(image_path) as image:
              # Resize the image to half of its original size
              image.thumbnail(tuple(x / 2 for x in image.size))
              # Save the resized image
              image.save(resized_path)
      
      # Lambda function handler
      def handler(event, context):
          # Iterate over records in the event
          for record in event['Records']:
              # Extract information from SQS message payload
              payload = record["body"]
              sqs_message = json.loads(str(payload))
              bucket_name = json.loads(str(sqs_message["Message"]))["Records"][0]["s3"]["bucket"]["name"]
              print(bucket_name)
              key = json.loads(str(sqs_message["Message"]))["Records"][0]["s3"]["object"]["key"]
              print(key)
      
              # Set paths for download and upload
              download_path = '/tmp/{}{}'.format(uuid.uuid4(), key.split("/")[1])  # Working code
              upload_path = '/tmp/resized-{}'.format(key.split("/")[1])
      
              # Download image from S3
              s3_client.download_file(bucket_name, key, download_path)
      
              # Resize image using the defined function
              resize_image(download_path, upload_path)
      
              # Upload resized image back to S3 within a 'thumbnail' folder
              s3.meta.client.upload_file(upload_path, bucket_name, 'thumbnail/Thumbnail-' + key.split("/")[1])


**Step Complete:**
You have successfully configured the Lambda function with an SQS trigger and uploaded the deployment package.

## Step 4.3: Configure Lambda Function Runtime Settings and Description

**Objective:** Configure the runtime settings and description for the Lambda function.

1. **Access the AWS Lambda Console:**
   - Open the AWS Lambda console.

2. **Navigate to CreateThumbnail Lambda Function:**
   - Select the "CreateThumbnail" Lambda function that you created.

3. **Edit Runtime Settings:**
   - In the "Runtime settings" section, choose "Edit."
   - In the "Handler" text field, enter `CreateThumbnail.handler`.
     - *Caution:* Make sure the Handler field is set to this value; otherwise, the Lambda function will not be found.
   - Choose "Save."

4. **Verify Runtime Settings Update:**
   - Check for the expected service output message:
     ```bash
     Successfully updated the function CreateThumbnail.
     ```

5. **Navigate to General Configuration:**
   - Choose the "Configuration" tab.
   - Choose "General configuration" from the panel on the left side of the screen.

6. **Edit Description:**
   - Choose "Edit."
   - In the "Description" text field, enter: "Create a thumbnail-sized image."
   - Leave the other settings at their default values.
   - Save Description Changes: Choose "Save."

7. **Verify Description Update:**
   - Check for the expected service output message:
     ```bash
     Successfully updated the function CreateThumbnail.
     ```

**Step Complete:**
You have successfully configured the runtime settings and description for the Lambda function.


## Lab Task 4.4: Create and Configure Two More Lambda Functions

### Lambda Function for Web Image

**Objective:** Create and configure a Lambda function for generating web-sized images.

1. **Create Lambda Function:**
   - Follow these steps to create a Lambda function named `CreateWebImage` with the following configurations:
      - Function name: Enter `CreateWebImage`.
      - Runtime: Choose Python 3.9.
      - Execution role: Choose the existing role with a name like `xxxxx-LabExecutionRole-xxxxx`.
      - Select a trigger: Choose SQS.
      - SQS Queue: Choose `web-queue`.
      - Batch Size: Enter 1.
   - Download and save the provided zip file (`CreateWebImage.zip`) to your computer.
   - Upload the zip file using the Lambda console.
   - Choose "Save."

2. **Configure Runtime Settings:**
   - In the "Runtime settings" section, choose "Edit."
   - In the "Handler" text field, enter `CreateWebImage.handler`.
   - In the "Description" text field, enter "Create a web-sized image."
   - Choose "Save."

### Lambda Function for Mobile Image

**Objective:** Create and configure a Lambda function for generating mobile-sized images.

1. **Create Lambda Function:**
   - Follow these steps to create a Lambda function named `CreateMobileImage` with the following configurations:
      - Function name: Enter `CreateMobileImage`.
      - Runtime: Choose Python 3.9.
      - Execution role: Choose the existing role with a name like `xxxxx-LabExecutionRole-xxxxx`.
      - Select a trigger: Choose SQS.
      - SQS Queue: Choose `mobile-queue`.
      - Batch Size: Enter 1.
   - Download and save the provided zip file (`CreateMobileImage.zip`) to your computer.
   - Upload the zip file using the Lambda console.
   - Choose "Save."

2. **Configure Runtime Settings:**
   - In the "Runtime settings" section, choose "Edit."
   - In the "Handler" text field, enter `CreateMobileImage.handler`.
   - In the "Description" text field, enter "Create a mobile-sized image."
   - Choose "Save."

**Task Complete:**
You have successfully created and configured Lambda functions for generating web and mobile images.

![lambda_function_image](https://github.com/renilsequeira/serverless-sns-sqs-lambda/assets/77531126/38afa05e-2faf-4ed3-8f3f-242d3e7f8692)


## Step 5: Upload an Object to the Amazon S3 Bucket

**Objective:** Upload an image object to the S3 bucket using the S3 console.

### Download an Image:

Download one of the following images to test your architecture:
- AWS logo: [AWS.jpg](path-to-image/AWS.jpg)
- Mona Lisa: [MonaLisa.jpg](path-to-image/MonaLisa.jpg)
- Happy Face: [HappyFace.jpg](path-to-image/HappyFace.jpg)

Save the file with a name similar to `InputFile.jpg`.

*Caution: Ensure that the file is saved with a .jpg extension, not .jpeg.*

### Access the S3 Management Console:

### Navigate to the Bucket and Folder:

1. In the S3 Management Console, choose the `xxxxx-bucket-xxxxx` bucket hyperlink.
2. create the folder, e.g., `ingest/`.

### Upload Image:

1. Choose "Upload."
2. In the Upload window, choose "Add files."
3. Browse to and choose the downloaded .jpg image file.
4. Choose "Upload."

### Verify Upload:

Check for the expected service output message:
```
Upload succeeded.
```

## Step 6: Validate the Processed File

### Step 6.1: Search Amazon CloudWatch Logs for Lambda Activity

**Objective:** Access and review Amazon CloudWatch Logs for Lambda activity.

1. **Access the AWS Lambda Console:**
   - Open the AWS Lambda console.

2. **Choose Lambda Function:**
   - Choose the hyperlink for one of your `Create-` functions (e.g., CreateThumbnail).

3. **Navigate to the Monitor Tab:**
   - Choose the "Monitor" tab.

4. **View CloudWatch Logs:**
   - The console displays graphs showing different metrics.
   - Choose "View CloudWatch logs."

5. **Choose Log Stream:**
   - Choose the hyperlink for the Log stream with the most recent timestamp.

6. **Expand Log Messages:**
   - Expand each message to view the log message details.
   - The REPORT line provides details like RequestId, Duration, Billed Duration, Memory Size, Max Memory Used, and Init Duration.

### Step 6.2: Validate the S3 Bucket for Processed Files

**Objective:** Access and validate the S3 bucket to confirm processed files.

1. **Access the S3 Management Console:**
   - Open the AWS Management Console.
   - In the search box, search for and select "S3."

2. **Navigate to Bucket and Folders:**
   - Choose the hyperlink for `xxxxx-bucket-xxxxx` to enter the bucket.

3. **Verify Processed Files:**
   - You should now see three new folders: `thumbnail`, `web`, and `mobile`.
   - Navigate through these folders to find the resized images (e.g., `Thumbnail-AWS.jpg`, `WebImage-HappyFace.jpg`, `MobileImage-MonaLisa.jpg`).

**Validation:**
   - If you find the resized images in these folders, you have successfully resized the image from its original to three different formats.

**Step Complete:** You have successfully validated the processed image file from the logs generated by the function code through Amazon CloudWatch Logs.

# Conclusion

Congratulations! You've successfully implemented a serverless image processing project with AWS services. Feel free to customize the project based on your requirements. If you have any questions or need assistance, don't hesitate to reach out. I'm here to help! ü§ùüí¨




